{"version":3,"sources":["stop-viewer.js"],"names":["StopViewer","_backClicked","props","clearViewedStop","_setLocationFromStop","type","setLocation","stopData","location","name","lat","lon","reverseGeocode","setState","popupPosition","_onClickPlanTo","_onClickPlanFrom","findStop","stopId","viewedStop","nextProps","hideBackButton","stopTimesByRoute","routes","stopTimes","forEach","routeId","patternTimes","pattern","id","split","now","diff","startOf","filteredTimes","times","filter","stopTime","realtimeDeparture","concat","clear","marginTop","sort","routeComparator","map","route","Component","propTypes","PropTypes","boolean","object","RouteRow","_toggleExpandedView","expanded","state","sortedStopTimes","a","b","shortName","longName","length","getFormattedStopTime","animation","fontSize","color","i","float","width","realtimeState","getStatusLabel","departureDelay","backgroundColor","headsign","marginRight","delay","Math","abs","mapStateToProps","ownProps","otp","ui","transitIndex","stops","mapDispatchToProps"],"mappings":"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","file":"stop-viewer.js","sourcesContent":["import React, { Component } from 'react'\nimport PropTypes from 'prop-types'\nimport { Button } from 'react-bootstrap'\nimport { connect } from 'react-redux'\nimport moment from 'moment'\nimport { VelocityTransitionGroup } from 'velocity-react'\n\nimport Icon from '../narrative/icon'\n\nimport { clearViewedStop } from '../../actions/ui'\nimport { findStop } from '../../actions/api'\nimport { setLocation } from '../../actions/map'\nimport { formatDuration, formatStopTime } from '../../util/time'\nimport { routeComparator } from '../../util/itinerary'\n\nclass StopViewer extends Component {\n  static propTypes = {\n    hideBackButton: PropTypes.boolean,\n    stopData: PropTypes.object,\n    viewedStop: PropTypes.object\n  }\n\n  _backClicked = () => {\n    this.props.clearViewedStop()\n  }\n\n  _setLocationFromStop = (type) => {\n    const { setLocation, stopData } = this.props\n    const location = {\n      name: stopData.name,\n      lat: stopData.lat,\n      lon: stopData.lon\n    }\n    setLocation({type, location, reverseGeocode: true})\n    this.setState({popupPosition: null})\n  }\n\n  _onClickPlanTo = () => this._setLocationFromStop('to')\n\n  _onClickPlanFrom = () => this._setLocationFromStop('from')\n\n  // load the viewed stop in the store when the Stop Viewer first mounts\n  componentWillMount () {\n    this.props.findStop({stopId: this.props.viewedStop.stopId})\n  }\n\n  // refresh the stop in the store if the viewed stop changes w/ the\n  // Stop Viewer already mounted\n  componentWillReceiveProps (nextProps) {\n    if (\n      this.props.viewedStop &&\n      nextProps.viewedStop &&\n      this.props.viewedStop.stopId !== nextProps.viewedStop.stopId\n    ) {\n      this.props.findStop({stopId: nextProps.viewedStop.stopId})\n    }\n  }\n\n  render () {\n    const { stopData, hideBackButton } = this.props\n\n    // construct a lookup table mapping routeId (e.g. 'MyAgency:10') to an array of stoptimes\n    const stopTimesByRoute = {}\n    if (stopData && stopData.routes && stopData.stopTimes) {\n      stopData.stopTimes.forEach(patternTimes => {\n        const routeId = patternTimes.pattern.id.split(':')[0] + ':' + patternTimes.pattern.id.split(':')[1]\n        if (!(routeId in stopTimesByRoute)) stopTimesByRoute[routeId] = []\n\n        const now = moment().diff(moment().startOf('day'), 'seconds')\n        const filteredTimes = patternTimes.times.filter(stopTime => {\n          const diff = stopTime.realtimeDeparture - now\n          return diff >= 0 && diff < 14400\n        })\n        stopTimesByRoute[routeId] = stopTimesByRoute[routeId].concat(filteredTimes)\n      })\n    }\n\n    return (\n      <div className='stop-viewer'>\n        {/* Header Block */}\n        <div className='stop-viewer-header'>\n          {/* Back button */}\n          {!hideBackButton && (\n            <div className='back-button-container'>\n              <Button\n                bsSize='small'\n                onClick={this._backClicked}\n              ><Icon type='arrow-left' />Back</Button>\n            </div>\n          )}\n\n          {/* Header Text */}\n          <div className='header-text'>\n            {stopData\n              ? <span>{stopData.name}</span>\n              : <span>Loading Stop..</span>\n            }\n          </div>\n          <div style={{ clear: 'both' }} />\n        </div>\n\n        {stopData && (\n          <div className='stop-viewer-body'>\n            <div>\n              <div><b>Stop ID</b>: {stopData.id}</div>\n              <b>Plan a trip:</b>{' '}\n              <Icon type='dot-circle-o' />{' '}\n              <button className='link-button'\n                onClick={this._onClickPlanFrom}>\n                From here\n              </button>{' '}|{' '}\n              <Icon type='map-marker' />{' '}\n              <button className='link-button'\n                onClick={this._onClickPlanTo}>\n                To here\n              </button>\n            </div>\n\n            {/* route listing */}\n            {stopData.routes && (\n              <div style={{ marginTop: 20 }}>\n                {stopData.routes.sort(routeComparator).map(route => {\n                  return (\n                    <RouteRow\n                      route={route}\n                      stopTimes={stopTimesByRoute[route.id]}\n                      key={route.id}\n                    />\n                  )\n                })}\n              </div>\n            )}\n\n            {/* Future: add stop details */}\n          </div>\n        )}\n      </div>\n    )\n  }\n}\n\nclass RouteRow extends Component {\n  constructor () {\n    super()\n    this.state = { expanded: false }\n  }\n\n  _toggleExpandedView = () => {\n    this.setState({ expanded: !this.state.expanded })\n  }\n\n  render () {\n    const { route, stopTimes } = this.props\n\n    // sort stop times by next departure\n    let sortedStopTimes = null\n    if (stopTimes) {\n      sortedStopTimes = stopTimes.sort((a, b) => {\n        if (a.realtimeDeparture < b.realtimeDeparture) return -1\n        if (a.realtimeDeparture > b.realtimeDeparture) return 1\n        return 0\n      })\n    }\n\n    return (\n      <div className='route-row'>\n        {/* header row */}\n        <div className='header'>\n          {/* route name */}\n          <div className='route-name'>\n            <b>{route.shortName}</b> {route.longName}\n          </div>\n\n          {/* next departure preview */}\n          {stopTimes && stopTimes.length > 0 && (\n            <div className='next-trip-preview'>\n              {getFormattedStopTime(sortedStopTimes[0])}\n            </div>\n          )}\n\n          {/* expansion chevron button */}\n          <div className='expansion-button-container'>\n            <button className='expansion-button' onClick={this._toggleExpandedView}>\n              <Icon type={`chevron-${this.state.expanded ? 'up' : 'down'}`} />\n            </button>\n          </div>\n        </div>\n\n        {/* expanded view */}\n        <VelocityTransitionGroup enter={{animation: 'slideDown'}} leave={{animation: 'slideUp'}}>\n          {this.state.expanded && (\n            <div className='trip-table'>\n              {/* trips table header row */}\n              <div style={{ fontSize: '11px', color: 'gray' }}>\n                <div className='trip-table-column-header'>STATUS</div>\n                <div className='trip-table-column-header'>DEPARTURE</div>\n                <div style={{ clear: 'both ' }} />\n              </div>\n\n              {/* list of upcoming trips */}\n              {stopTimes && (\n                sortedStopTimes.map((stopTime, i) => {\n                  return (\n                    <div className='trip-row' style={{ marginTop: 6, fontSize: 14 }} key={i}>\n                      <div style={{ float: 'right', width: 80 }}>\n                        {stopTime.realtimeState === 'UPDATED'\n                          ? getStatusLabel(stopTime.departureDelay)\n                          : <div className='status-label' style={{ backgroundColor: '#bbb' }}>Scheduled</div>\n                        }\n                      </div>\n\n                      <div style={{ float: 'right', width: 80 }}>\n                        {getFormattedStopTime(stopTime)}\n                      </div>\n\n                      <div key={i}>\n                        To {stopTime.headsign}\n                      </div>\n\n                      <div style={{ clear: 'both ' }} />\n                    </div>\n                  )\n                })\n              )}\n            </div>\n          )}\n        </VelocityTransitionGroup>\n      </div>\n    )\n  }\n}\n\n// helper method to generate stop time w/ status icon\nfunction getFormattedStopTime (stopTime) {\n  return (\n    <span>\n      {stopTime.realtimeState === 'UPDATED'\n        ? <Icon type='rss' style={{ color: '#888', fontSize: '0.8em', marginRight: 2 }} />\n        : <Icon type='clock-o' style={{ color: '#888', fontSize: '0.8em', marginRight: 2 }} />\n      }\n      {formatStopTime(stopTime.realtimeDeparture)}\n    </span>\n  )\n}\n\n// helper method to generate status label\nfunction getStatusLabel (delay) {\n  // late departure\n  if (delay > 60) {\n    return (\n      <div className='status-label' style={{ backgroundColor: '#d9534f' }}>\n        {formatDuration(delay)} Late\n      </div>\n    )\n  }\n\n  // early departure\n  if (delay < -60) {\n    return (\n      <div className='status-label' style={{ backgroundColor: '#337ab7' }}>\n        {formatDuration(Math.abs(delay))} Early\n      </div>\n    )\n  }\n\n  // on-time departure\n  return (\n    <div className='status-label' style={{ backgroundColor: '#5cb85c' }}>\n      On Time\n    </div>\n  )\n}\n\n// connect to redux store\n\nconst mapStateToProps = (state, ownProps) => {\n  return {\n    viewedStop: state.otp.ui.viewedStop,\n    stopData: state.otp.transitIndex.stops[state.otp.ui.viewedStop.stopId]\n  }\n}\n\nconst mapDispatchToProps = {\n  clearViewedStop,\n  findStop,\n  setLocation\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(StopViewer)\n"]}