{"version":3,"sources":["create-otp-reducer.js"],"names":["defaultConfig","autoPlan","debouncePlanTimeMs","realtimeEffectsDisplayThreshold","operators","options","defaultQuery","home","work","trackRecent","recentPlaces","recentSearches","locations","filter","p","createOtpReducer","config","initialQuery","currentQuery","push","map","l","type","queryModes","mode","split","includes","m","concat","join","routingType","initialState","location","currentPosition","error","coords","fetching","sessionSearches","nearbyStops","user","searches","transitIndex","stops","trips","useRealtime","activeSearchId","overlay","bikeRental","stations","carRental","parkAndRide","transit","transitive","zipcar","tnc","etaEstimates","rideEstimates","ui","mobileScreen","MobileScreens","WELCOME_SCREEN","printView","window","href","indexOf","diagramLeg","state","action","searchId","payload","activeItinerary","urlParams","length","ui_activeItinerary","$set","activeLeg","activeStep","pending","query","response","nonRealtimeResponse","index","console","log","$merge","localStorage","removeItem","defaults","setItem","locationIndex","findIndex","id","removeIndex","splice","$splice","duplicateIndex","lat","lon","locationsUpdate","firstIndex","lastIndex","forEach","i","$push","s","initLat","initLon","initZoom","zoom","elevationPoint","mapPopupLocation","position","$unshift","stopLookup","stopId","routes","mainPanelContent","viewedStop","viewedTrip","viewedRoute","tripId","stopTimes","geometry","currentRouteIds","newRoutes","key","reduce","res","routeId","patterns","patternId","from","fromData","estimates","estimate","company","productId","estimateTimestamp","Date","rideEstimate","to","rideType"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AAEA;;AAMA;;AACA;;AACA;;;;AAEA,IAAMA,gBAAgB;AACpBC,YAAU,KADU;AAEpBC,sBAAoB,CAFA;AAGpBC,mCAAiC,GAHb;AAIpBC,aAAW;;AAGb;AACA;AARsB,CAAtB,CASA,IAAMC,UAAU,+BAAmB,kBAAnB,CAAhB;AACA,IAAMC,eAAe,sBAAc,6BAAd,EAAiCD,OAAjC,CAArB;AACA,IAAME,OAAO,+BAAmB,UAAnB,EAA+B,IAA/B,CAAb;AACA,IAAMC,OAAO,+BAAmB,UAAnB,EAA+B,IAA/B,CAAb;AACA,IAAMC,cAAc,+BAAmB,iBAAnB,EAAsC,IAAtC,KAA+C,KAAnE;AACA,IAAMC,eAAe,+BAAmB,YAAnB,EAAiC,IAAjC,KAA0C,EAA/D;AACA,IAAMC,iBAAiB,+BAAmB,oBAAnB,EAAyC,IAAzC,KAAkD,EAAzE;AACA,IAAMC,YAAY,CAACL,IAAD,EAAOC,IAAP,0CAAgBE,YAAhB,GAA8BG,MAA9B,CAAqC;AAAA,SAAKC,CAAL;AAAA,CAArC,CAAlB;AACA;;AAEA;;AAEA,SAASC,gBAAT,CAA2BC,MAA3B,EAAmCC,YAAnC,EAAiD;AAC/C;AACA,MAAMC,eAAe,sBAAcZ,YAAd,EAA4BW,YAA5B,CAArB;AACA,MAAID,OAAOJ,SAAX,EAAsB;AACpBA,cAAUO,IAAV,mDAAkBH,OAAOJ,SAAP,CAAiBQ,GAAjB,CAAqB;AAAA,wCAAWC,CAAX,IAAcC,MAAM,WAApB;AAAA,KAArB,CAAlB;AACD;AACD,MAAIC,aAAaL,aAAaM,IAAb,CAAkBC,KAAlB,CAAwB,GAAxB,CAAjB;;AAEA;AACA,MAAIF,WAAWG,QAAX,CAAoB,SAApB,CAAJ,EAAoC;AAClC;AACAH,iBAAaA,WAAWV,MAAX,CAAkB;AAAA,aAAK,CAAC,0BAAUc,CAAV,CAAN;AAAA,KAAlB,CAAb;AACA;AACAJ,iBAAaA,WAAWK,MAAX,CAAkB,gCAAgBZ,MAAhB,CAAlB,CAAb;AACA;AACAE,iBAAaM,IAAb,GAAoBD,WAAWM,IAAX,CAAgB,GAAhB,CAApB;AACD;;AAED;AACA,MAAIX,aAAaY,WAAb,KAA6B,WAAjC,EAA8C;AAC5CP,iBAAa,mCAAuBA,UAAvB,CAAb;AACD;;AAED,MAAMQ,eAAe;AACnBf,YAAQ,sBAAchB,aAAd,EAA6BgB,MAA7B,CADW;AAEnBE,8BAFmB;AAGnBc,cAAU;AACRC,uBAAiB;AACfC,eAAO,IADQ;AAEfC,gBAAQ,IAFO;AAGfC,kBAAU;AAHK,OADT;AAMRC,uBAAiB,EANT;AAORC,mBAAa;AAPL,KAHS;AAYnBC,UAAM;AACJ9B,8BADI;AAEJG,0BAFI;AAGJD;AAHI,KAZa;AAiBnB6B,cAAU,EAjBS;AAkBnBC,kBAAc;AACZC,aAAO,EADK;AAEZC,aAAO;AAFK,KAlBK;AAsBnBC,iBAAa,IAtBM;AAuBnBC,oBAAgB,CAvBG;AAwBnBC,aAAS;AACPC,kBAAY;AACVC,kBAAU;AADA,OADL;AAIPC,iBAAW;AACTD,kBAAU;AADD,OAJJ;AAOPE,mBAAa;AACX;AACAtC,mBAAW;AAFA,OAPN;AAWPuC,eAAS;AACPT,eAAO;AADA,OAXF;AAcPU,kBAAY,IAdL;AAePC,cAAQ;AACNzC,mBAAW;AADL;AAfD,KAxBU;AA2CnB0C,SAAK;AACHC,oBAAc,EADX;AAEHC,qBAAe;AAFZ,KA3Cc;AA+CnBC,QAAI;AACFC,oBAAcC,kBAAcC,cAD1B;AAEFC,iBAAWC,OAAO9B,QAAP,CAAgB+B,IAAhB,CAAqBC,OAArB,CAA6B,SAA7B,MAA4C,CAAC,CAFtD;AAGFC,kBAAY;AAHV;AA/Ce,GAArB;;AAsDA,SAAO,YAAkC;AAAA,QAAjCC,KAAiC,uEAAzBnC,YAAyB;AAAA,QAAXoC,MAAW;;AACvC,QAAMC,WAAWD,OAAOE,OAAP,IAAkBF,OAAOE,OAAP,CAAeD,QAAlD;AACA,YAAQD,OAAO7C,IAAf;AACE,WAAK,iBAAL;AACE;AACA;AACA;AACA,YAAIgD,kBAAkBJ,MAAMhD,YAAN,CAAmBY,WAAnB,KAAmC,WAAnC,GAAiD,CAAjD,GAAqD,IAA3E;AACA;AACA;AACA;AACA,YAAMyC,YAAY,0BAAlB;AACA,YACE,CAAC,CAACL,MAAM1B,QAAP,IAAmB,oBAAY0B,MAAM1B,QAAlB,EAA4BgC,MAA5B,KAAuC,CAA3D,KACAD,UAAUE,kBAFZ,EAGE;AACAH,4BAAkB,CAACC,UAAUE,kBAA7B;AACD;;AAED,eAAO,kCAAOP,KAAP,EAAc;AACnB1B,sDACG4B,QADH,EACc;AACVM,kBAAM;AACJJ,8CADI;AAEJK,yBAAW,IAFP;AAGJC,0BAAY,IAHR;AAIJC,uBAAS,IAJL;AAKJC,qBAAO,qBAAMZ,MAAMhD,YAAZ,CALH;AAMJ6D,wBAAU;AANN;AADI,WADd,CADmB;AAanBlC,0BAAgB,EAAE6B,MAAMN,QAAR;AAbG,SAAd,CAAP;AAeF,WAAK,eAAL;AACE,eAAO,kCAAOF,KAAP,EAAc;AACnB1B,sDACG4B,QADH,EACc;AACVW,sBAAU;AACRL,oBAAM;AACJxC,uBAAOiC,OAAOE,OAAP,CAAenC;AADlB;AADE,aADA;AAMV2C,qBAAS,EAAEH,MAAM,KAAR;AANC,WADd;AADmB,SAAd,CAAP;AAYF,WAAK,kBAAL;AACE,YAAMK,WAAYb,MAAMhD,YAAN,CAAmBY,WAAnB,KAAmC,SAApC,GACb,mCAAqBqC,OAAOE,OAAP,CAAeU,QAApC,CADa,GAEbZ,OAAOE,OAAP,CAAeU,QAFnB;;AAIA,eAAO,kCAAOb,KAAP,EAAc;AACnB1B,sDACG4B,QADH,EACc;AACVW,sBAAU,EAAEL,MAAMK,QAAR,EADA;AAEVF,qBAAS,EAAEH,MAAM,KAAR;AAFC,WADd,CADmB;AAOnBjB,cAAI;AACFQ,wBAAY,EAAES,MAAM,KAAR;AADV;AAPe,SAAd,CAAP;AAWF,WAAK,+BAAL;AACE,eAAO,kCAAOR,KAAP,EAAc;AACnB1B,sDACG4B,QADH,EACc;AACVY,iCAAqB,EAAEN,MAAMP,OAAOE,OAAP,CAAeU,QAAvB;AADX,WADd;AADmB,SAAd,CAAP;AAOF,WAAK,qBAAL;AACE,eAAO,kCAAOb,KAAP,EAAc;AACnBpB,mBAAS;AACPC,wBAAY;AACV8B,uBAAS,EAAEH,MAAM,IAAR,EADC;AAEVxC,qBAAO,EAAEwC,MAAM,IAAR;AAFG;AADL;AADU,SAAd,CAAP;AAQF,WAAK,mBAAL;AACE,eAAO,kCAAOR,KAAP,EAAc;AACnBpB,mBAAS;AACPC,wBAAY;AACV8B,uBAAS,EAAEH,MAAM,KAAR,EADC;AAEVxC,qBAAO,EAAEwC,MAAMP,OAAOE,OAAf;AAFG;AADL;AADU,SAAd,CAAP;AAQF,WAAK,sBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc;AACnBpB,mBAAS;AACPC,wBAAY;AACVC,wBAAU,EAAE0B,MAAMP,OAAOE,OAAP,CAAerB,QAAvB,EADA;AAEV6B,uBAAS,EAAEH,MAAM,KAAR;AAFC;AADL;AADU,SAAd,CAAP;AAQF,WAAK,kBAAL;AACE,eAAO,kCAAOR,KAAP,EAAc;AACnBpB,mBAAS;AACPG,uBAAW;AACT4B,uBAAS,EAAEH,MAAM,KAAR,EADA;AAETxC,qBAAO,EAAEwC,MAAMP,OAAOE,OAAf;AAFE;AADJ;AADU,SAAd,CAAP;AAQF,WAAK,qBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc;AACnBpB,mBAAS;AACPG,uBAAW;AACTD,wBAAU,EAAE0B,MAAMP,OAAOE,OAAP,CAAerB,QAAvB,EADD;AAET6B,uBAAS,EAAEH,MAAM,KAAR;AAFA;AADJ;AADU,SAAd,CAAP;AAQF,WAAK,2BAAL;AACE,eAAO,kCAAOR,KAAP,EAAc;AACnBtB,uBAAa,EAAE8B,MAAMP,OAAOE,OAAP,CAAezB,WAAvB;AADM,SAAd,CAAP;AAGF,WAAK,sBAAL;AACE,YAAIsB,MAAMrB,cAAN,KAAyB,IAA7B,EAAmC;AACjC,iBAAO,kCAAOqB,KAAP,EAAc;AACnB1B,wDACG0B,MAAMrB,cADT,EAC0B;AACtByB,+BAAiB,EAAEI,MAAMP,OAAOE,OAAP,CAAeY,KAAvB,EADK;AAEtBN,yBAAW,EAAED,MAAM,IAAR,EAFW;AAGtBE,0BAAY,EAAEF,MAAM,IAAR;AAHU,aAD1B;AADmB,WAAd,CAAP;AASD;AACD,eAAOR,KAAP;AACF,WAAK,gBAAL;AACE,YAAIA,MAAMrB,cAAN,KAAyB,IAA7B,EAAmC;AACjC,iBAAO,kCAAOqB,KAAP,EAAc;AACnB1B,wDACG0B,MAAMrB,cADT,EAC0B;AACtB8B,yBAAW,EAAED,MAAMP,OAAOE,OAAP,CAAeY,KAAvB,EADW;AAEtBL,0BAAY,EAAEF,MAAM,IAAR;AAFU,aAD1B;AADmB,WAAd,CAAP;AAQD;AACD,eAAOR,KAAP;AACF,WAAK,iBAAL;AACE,YAAIA,MAAMrB,cAAN,KAAyB,IAA7B,EAAmC;AACjC,iBAAO,kCAAOqB,KAAP,EAAc;AACnB1B,wDACG0B,MAAMrB,cADT,EAC0B;AACtB+B,0BAAY,EAAEF,MAAMP,OAAOE,OAAP,CAAeY,KAAvB;AADU,aAD1B;AADmB,WAAd,CAAP;AAOD;AACD,eAAOf,KAAP;AACF,WAAK,cAAL;AACE,eAAO,kCAAOA,KAAP,EAAc;AACnBhD,0DACGiD,OAAOE,OAAP,CAAe/C,IADlB,EACyB,EAAEoD,MAAMP,OAAOE,OAAP,CAAerC,QAAvB,EADzB;AADmB,SAAd,CAAP;AAKF,WAAK,gBAAL;AACE,eAAO,kCAAOkC,KAAP,EAAc;AACnBhD,0DAAiBiD,OAAOE,OAAP,CAAe/C,IAAhC,EAAuC,EAAEoD,MAAM,IAAR,EAAvC;AADmB,SAAd,CAAP;;AAIF,WAAK,iBAAL;AACEQ,gBAAQC,GAAR,CAAY,aAAZ,EAA2BhB,OAAOE,OAAlC;AACA,eAAO,kCAAOH,KAAP,EAAc,EAAEhD,cAAc,EAAEkE,QAAQjB,OAAOE,OAAjB,EAAhB,EAAd,CAAP;;AAEF,WAAK,qBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc,EAAErB,gBAAgB,EAAE6B,MAAM,IAAR,EAAlB,EAAd,CAAP;AACF,WAAK,wBAAL;AACEZ,eAAOuB,YAAP,CAAoBC,UAApB,CAA+B,kBAA/B;AACA,eAAO,kCAAOpB,KAAP,EAAc,EAAEqB,UAAU,EAAEb,MAAM,IAAR,EAAZ,EAAd,CAAP;AACF,WAAK,wBAAL;AACEZ,eAAOuB,YAAP,CAAoBG,OAApB,CAA4B,kBAA5B,EAAgD,yBAAerB,OAAOE,OAAtB,CAAhD;AACA,eAAO,kCAAOH,KAAP,EAAc,EAAEqB,UAAU,EAAEb,MAAMP,OAAOE,OAAf,EAAZ,EAAd,CAAP;AACF,WAAK,cAAL;AAAqB;AACnB,cAAMzD,aAAY,qBAAMsD,MAAM3B,IAAN,CAAW3B,SAAjB,CAAlB;AACA,cAAM6E,gBAAgB7E,WAAU8E,SAAV,CAAoB;AAAA,mBAAKrE,EAAEsE,EAAF,KAASxB,OAAOE,OAArB;AAAA,WAApB,CAAtB;AACA,cAAIF,OAAOE,OAAP,CAAeL,OAAf,CAAuB,QAAvB,MAAqC,CAAC,CAA1C,EAA6C;AAC3C;AACA,gBAAMtD,gBAAeE,WAAUC,MAAV,CAAiB;AAAA,qBAAKQ,EAAEC,IAAF,KAAW,QAAhB;AAAA,aAAjB,CAArB;AACA,gBAAMsE,cAAclF,cAAagF,SAAb,CAAuB;AAAA,qBAAKrE,EAAEsE,EAAF,KAASxB,OAAOE,OAArB;AAAA,aAAvB,CAApB;AACA3D,0BAAamF,MAAb,CAAoBD,WAApB,EAAiC,CAAjC;AACA9B,mBAAOuB,YAAP,CAAoBG,OAApB,eAA0C,yBAAe9E,aAAf,CAA1C;AACD,WAND,MAMO;AACLoD,mBAAOuB,YAAP,CAAoBC,UAApB,UAAsCnB,OAAOE,OAA7C;AACD;AACD,iBAAOoB,kBAAkB,CAAC,CAAnB,GACH,kCAAOvB,KAAP,EAAc,EAAE3B,MAAM,EAAE3B,WAAW,EAAEkF,SAAS,CAAC,CAACL,aAAD,EAAgB,CAAhB,CAAD,CAAX,EAAb,EAAR,EAAd,CADG,GAEHvB,KAFJ;AAGD;AACD,WAAK,iBAAL;AAAwB;AACtBJ,iBAAOuB,YAAP,CAAoBG,OAApB,CAA4B,iBAA5B,EAA+C,yBAAerB,OAAOE,OAAtB,CAA/C;AACA,cAAIzD,cAAY,qBAAMsD,MAAM3B,IAAN,CAAW3B,SAAjB,CAAhB;AACA,cAAI,CAACuD,OAAOE,OAAZ,EAAqB;AACnB;AACAzD,0BAAYA,YAAUC,MAAV,CAAiB;AAAA,qBAAKQ,EAAEC,IAAF,KAAW,QAAhB;AAAA,aAAjB,CAAZ;AACAwC,mBAAOuB,YAAP,CAAoBC,UAApB;AACAxB,mBAAOuB,YAAP,CAAoBC,UAApB;AACD;AACD,iBAAO,kCAAOpB,KAAP,EAAc,EAAE3B,MAAM;AAC3B9B,2BAAa,EAAEiE,MAAMP,OAAOE,OAAf,EADc;AAE3BzD,yBAAW,EAAE8D,MAAM9D,WAAR,EAFgB;AAG3BD,8BAAgB,EAAE+D,MAAM,EAAR;AAHW,aAAR,EAAd,CAAP;AAKD;AACD,WAAK,gBAAL;AAAuB;AAAA,gCACMP,OAAOE,OADb;AAAA,cACbrC,QADa,mBACbA,QADa;AAAA,cACHV,IADG,mBACHA,IADG;;AAErB,cAAMV,cAAY,qBAAMsD,MAAM3B,IAAN,CAAW3B,SAAjB,CAAlB;AACA,cAAMmF,kBAAiBnF,YAAU8E,SAAV,CAAoB;AAAA,mBAAKrE,EAAE2E,GAAF,KAAUhE,SAASgE,GAAnB,IAA0B3E,EAAE4E,GAAF,KAAUjE,SAASiE,GAAlD;AAAA,WAApB,CAAvB;AACA,cAAIC,wBAAJ;AACA,cAAIlE,SAASV,IAAT,KAAkB,QAAtB,EAAgC;AAC9B,gBAAI6E,aAAa,CAAC,CAAlB;AACA,gBAAIC,YAAY,CAAC,CAAjB;AACAxF,wBAAUyF,OAAV,CAAkB,UAAChF,CAAD,EAAIiF,CAAJ,EAAU;AAC1B,kBAAIjF,EAAEC,IAAF,KAAW,QAAf,EAAyB;AACvB,oBAAI6E,eAAe,CAAC,CAApB,EAAuBA,aAAaG,CAAb,CAAvB,KACKF,YAAYE,CAAZ;AACN;AACF,aALD;AAMA,gBAAM5F,iBAAeE,YAAUC,MAAV,CAAiB;AAAA,qBAAKQ,EAAEC,IAAF,KAAW,QAAhB;AAAA,aAAjB,CAArB;AACA,gBAAIyE,oBAAmB,CAAC,CAAxB,EAA2B;AACzB;AACA;AACA,qBAAO7B,KAAP;AACD;AACD;AACA;AACA,gBAAIxD,eAAa8D,MAAb,IAAuB,CAA3B,EAA8B;AAC5B9D,6BAAamF,MAAb,CAAoBO,SAApB,EAA+B,CAA/B,EAAkCpE,QAAlC;AACAkE,gCAAkB,EAAEJ,SAAS,CAAC,CAACM,SAAD,EAAY,CAAZ,EAAepE,QAAf,CAAD,CAAX,EAAlB;AACD,aAHD,MAGO;AACLtB,6BAAaS,IAAb,CAAkBa,QAAlB;AACAkE,gCAAkB,EAAEK,OAAO,CAACvE,QAAD,CAAT,EAAlB;AACD;AACD8B,mBAAOuB,YAAP,CAAoBG,OAApB,eAA0C,yBAAe9E,cAAf,CAA1C;AACD,WAzBD,MAyBO;AACL,gBAAIqF,oBAAmB,CAAC,CAAxB,EAA2B,CAG1B;AAFC;AACA;;AAEF;AACA,gBAAMd,QAAQrE,YAAU8E,SAAV,CAAoB;AAAA,qBAAKrE,EAAEC,IAAF,KAAWA,IAAhB;AAAA,aAApB,CAAd;AACA,gBAAI2D,UAAU,CAAC,CAAf,EAAkB;AAChBiB,gCAAkB,EAAEJ,SAAS,CAAC,CAACb,KAAD,EAAQ,CAAR,EAAWjD,QAAX,CAAD,CAAX,EAAlB;AACD,aAFD,MAEO;AACLkE,gCAAkB,EAAEK,OAAO,CAACvE,QAAD,CAAT,EAAlB;AACD;AACD8B,mBAAOuB,YAAP,CAAoBG,OAApB,UAAmClE,IAAnC,EAA2C,yBAAeU,QAAf,CAA3C;AACD;AACD,iBAAO,kCAAOkC,KAAP,EAAc,EAAE3B,MAAM,EAAE3B,WAAWsF,eAAb,EAAR,EAAd,CAAP;AACD;AACD,WAAK,iBAAL;AACE,YAAM1D,WAAW,qBAAM0B,MAAM3B,IAAN,CAAW5B,cAAjB,CAAjB;AACA,YAAMoF,iBAAiBvD,SAASkD,SAAT,CAAmB;AAAA,iBAAK,sBAAQc,EAAE1B,KAAV,EAAiBX,OAAOE,OAAP,CAAeS,KAAhC,CAAL;AAAA,SAAnB,CAAvB;AACA;AACA,YAAIiB,mBAAmB,CAAC,CAAxB,EAA2B;AACzB,iBAAO7B,KAAP;AACD;AACD1B,iBAASrB,IAAT,CAAcgD,OAAOE,OAArB;AACAP,eAAOuB,YAAP,CAAoBG,OAApB,uBAAkD,yBAAehD,QAAf,CAAlD;AACA,eAAO,kCAAO0B,KAAP,EAAc,EAAE3B,MAAM,EAAEC,UAAU,EAAEkC,MAAMlC,QAAR,EAAZ,EAAR,EAAd,CAAP;AACF,WAAK,eAAL;AAAsB;AACpB,cAAM7B,kBAAiB,qBAAMuD,MAAM3B,IAAN,CAAW5B,cAAjB,CAAvB;AACA,cAAMsE,SAAQtE,gBAAe+E,SAAf,CAAyB;AAAA,mBAAKrE,EAAEsE,EAAF,KAASxB,OAAOE,OAArB;AAAA,WAAzB,CAAd;AACA;AACA1D,0BAAekF,MAAf,CAAsBZ,MAAtB,EAA6B,CAA7B;AACAnB,iBAAOuB,YAAP,CAAoBG,OAApB,uBAAkD,yBAAe7E,eAAf,CAAlD;AACA,iBAAOsE,WAAU,CAAC,CAAX,GACH,kCAAOf,KAAP,EAAc,EAAE3B,MAAM,EAAE5B,gBAAgB,EAAEmF,SAAS,CAAC,CAACb,MAAD,EAAQ,CAAR,CAAD,CAAX,EAAlB,EAAR,EAAd,CADG,GAEHf,KAFJ;AAGD;AACD,WAAK,cAAL;AACE,eAAO,kCAAOA,KAAP,EAAc;AACnBlD,kBAAQ,EAAEf,UAAU,EAAEyE,MAAMP,OAAOE,OAAP,CAAepE,QAAvB,EAAZ;AADW,SAAd,CAAP;AAGF,WAAK,gBAAL;AACE,eAAO,kCAAOiE,KAAP,EAAc;AACnBlD,kBAAQ;AACNI,iBAAK;AACHqF,uBAAS,EAAE/B,MAAMP,OAAOE,OAAP,CAAe2B,GAAvB,EADN;AAEHU,uBAAS,EAAEhC,MAAMP,OAAOE,OAAP,CAAe4B,GAAvB;AAFN;AADC;AADW,SAAd,CAAP;AAQF,WAAK,cAAL;AACE,eAAO,kCAAO/B,KAAP,EAAc;AACnBlD,kBAAQ;AACNI,iBAAK;AACHuF,wBAAU,EAAEjC,MAAMP,OAAOE,OAAP,CAAeuC,IAAvB;AADP;AADC;AADW,SAAd,CAAP;AAOF,WAAK,kBAAL;AACE,eAAO,kCAAO1C,KAAP,EAAc;AACnBT,cAAI;AACFQ,wBAAY,EAAES,MAAMP,OAAOE,OAAf;AADV;AADe,SAAd,CAAP;AAKF,WAAK,qBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc;AACnBT,cAAI;AACFoD,4BAAgB,EAAEnC,MAAMP,OAAOE,OAAf;AADd;AADe,SAAd,CAAP;AAKF,WAAK,wBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc;AACnBT,cAAI;AACFqD,8BAAkB,EAAEpC,MAAMP,OAAOE,OAAP,CAAerC,QAAvB;AADhB;AADe,SAAd,CAAP;AAKF,WAAK,mBAAL;AACE,eAAO,kCAAOkC,KAAP,EAAc;AACnBlC,oBAAU;AACRC,6BAAiB,EAAEmD,QAAQ,EAAEhD,UAAU+B,OAAOE,OAAP,CAAe/C,IAA3B,EAAV;AADT;AADS,SAAd,CAAP;AAKF,WAAK,gBAAL;AACE,eAAO,kCAAO4C,KAAP,EAAc;AACnBlC,oBAAU,EAAEC,iBAAiB,EAAEyC,MAAMP,OAAOE,OAAf,EAAnB;AADS,SAAd,CAAP;AAGF,WAAK,mBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc;AACnBlC,oBAAU,EAAEC,iBAAiB,EAAEyC,MAAMP,OAAOE,OAAP,CAAe0C,QAAvB,EAAnB;AADS,SAAd,CAAP;AAGF,WAAK,qBAAL;AACE,eAAO,kCAAO7C,KAAP,EAAc;AACnBlC,oBAAU,EAAEK,iBAAiB,EAAE2E,UAAU,CAAC7C,OAAOE,OAAP,CAAerC,QAAhB,CAAZ,EAAnB;AADS,SAAd,CAAP;;AAIF,WAAK,uBAAL;AACE,YAAMiF,aAAa,EAAnB;AACA9C,eAAOE,OAAP,CAAe3B,KAAf,CAAqB2D,OAArB,CAA6B,aAAK;AAChCY,qBAAWT,EAAEb,EAAb,IAAmBa,CAAnB;AACD,SAFD;AAGA,eAAO,kCAAOtC,KAAP,EAAc;AACnBlC,oBAAU;AACRM,yBAAa,EAAEoC,MAAMP,OAAOE,OAAP,CAAe3B,KAAf,CAAqBtB,GAArB,CAAyB;AAAA,uBAAKoF,EAAEb,EAAP;AAAA,eAAzB,CAAR;AADL,WADS;AAInBlD,wBAAc,EAAEC,OAAO,EAAE0C,QAAQ6B,UAAV,EAAT;AAJK,SAAd,CAAP;AAMF,WAAK,4BAAL;AACE,eAAO,kCAAO/C,KAAP,EAAc;AACnBpB,mBAAS;AACPK,qBAAS;AACPT,qBAAO,EAAEgC,MAAMP,OAAOE,OAAP,CAAe3B,KAAvB,EADA;AAEPmC,uBAAS,EAAEH,MAAM,KAAR;AAFF;AADF;AADU,SAAd,CAAP;AAQF,WAAK,qBAAL;AACE,eAAO,kCAAOR,KAAP,EAAc;AACnBpB,mBAAS;AACPK,qBAAS;AACPT,qBAAO,EAAEgC,MAAM,EAAR,EADA;AAEPG,uBAAS,EAAEH,MAAM,KAAR;AAFF;AADF;AADU,SAAd,CAAP;AAQF,WAAK,yBAAL;AACE,eAAO,kCAAOR,KAAP,EAAc;AACnBzB,wBAAc;AACZC,qDACGyB,OAAOE,OAAP,CAAe6C,MADlB,EAC2B;AACvBC,sBAAQ,EAAEzC,MAAMP,OAAOE,OAAP,CAAe8C,MAAvB;AADe,aAD3B;AADY;AADK,SAAd,CAAP;AASF,WAAK,mBAAL;AACE,eAAO,kCAAOjD,KAAP,EAAc,EAAET,IAAI,EAAEC,cAAc,EAAEgB,MAAMP,OAAOE,OAAf,EAAhB,EAAN,EAAd,CAAP;AACF,WAAK,wBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc;AACnBT,cAAI,EAAE2D,kBAAkB,EAAE1C,MAAMP,OAAOE,OAAf,EAApB;AADe,SAAd,CAAP;AAGF,WAAK,iBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc,EAAET,IAAI,EAAE4D,YAAY,EAAE3C,MAAMP,OAAOE,OAAf,EAAd,EAAN,EAAd,CAAP;AACF,WAAK,mBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc,EAAET,IAAI,EAAE4D,YAAY,EAAE3C,MAAM,IAAR,EAAd,EAAN,EAAd,CAAP;;AAEF,WAAK,iBAAL;AACE,eAAO,kCAAOR,KAAP,EAAc,EAAET,IAAI,EAAE6D,YAAY,EAAE5C,MAAMP,OAAOE,OAAf,EAAd,EAAN,EAAd,CAAP;AACF,WAAK,mBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc,EAAET,IAAI,EAAE6D,YAAY,EAAE5C,MAAM,IAAR,EAAd,EAAN,EAAd,CAAP;;AAEF,WAAK,kBAAL;AACE,eAAO,kCAAOR,KAAP,EAAc,EAAET,IAAI,EAAE8D,aAAa,EAAE7C,MAAMP,OAAOE,OAAf,EAAf,EAAN,EAAd,CAAP;;AAEF,WAAK,oBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc;AACnBzB,wBAAc;AACZC,qDAAUyB,OAAOE,OAAP,CAAesB,EAAzB,EAA8B,EAAEjB,MAAMP,OAAOE,OAAf,EAA9B;AADY;AADK,SAAd,CAAP;AAKF,WAAK,oBAAL;AACE,eAAO,kCAAOH,KAAP,EAAc;AACnBzB,wBAAc;AACZE,qDAAUwB,OAAOE,OAAP,CAAesB,EAAzB,EAA8B,EAAEjB,MAAMP,OAAOE,OAAf,EAA9B;AADY;AADK,SAAd,CAAP;AAKF,WAAK,8BAAL;AACE,eAAO,kCAAOH,KAAP,EAAc;AACnBzB,wBAAc;AACZE,qDACGwB,OAAOE,OAAP,CAAemD,MADlB,EAC2B,EAAE9E,OAAO,EAAEgC,MAAMP,OAAOE,OAAP,CAAe3B,KAAvB,EAAT,EAD3B;AADY;AADK,SAAd,CAAP;AAOF,WAAK,mCAAL;AACE,eAAO,kCAAOwB,KAAP,EAAc;AACnBzB,wBAAc;AACZE,qDACGwB,OAAOE,OAAP,CAAemD,MADlB,EAC2B;AACvBC,yBAAW,EAAE/C,MAAMP,OAAOE,OAAP,CAAeoD,SAAvB;AADY,aAD3B;AADY;AADK,SAAd,CAAP;AASF,WAAK,iCAAL;AACE,eAAO,kCAAOvD,KAAP,EAAc;AACnBzB,wBAAc;AACZE,qDACGwB,OAAOE,OAAP,CAAemD,MADlB,EAC2B;AACvBE,wBAAU,EAAEhD,MAAMP,OAAOE,OAAP,CAAeqD,QAAvB;AADa,aAD3B;AADY;AADK,SAAd,CAAP;AASF,WAAK,mCAAL;AACE,eAAO,kCAAOxD,KAAP,EAAc;AACnBzB,wBAAc;AACZC,qDACGyB,OAAOE,OAAP,CAAe6C,MADlB,EAC2B;AACvBO,yBAAW,EAAE/C,MAAMP,OAAOE,OAAP,CAAeoD,SAAvB;AADY,aAD3B;AADY;AADK,SAAd,CAAP;;AAUF,WAAK,sBAAL;AACE;AACA,YAAI,CAACvD,MAAMzB,YAAN,CAAmB0E,MAAxB,EAAgC;AAC9B,iBAAO,kCAAOjD,KAAP,EAAc;AACnBzB,0BAAc,EAAE0E,QAAQ,EAAEzC,MAAMP,OAAOE,OAAf,EAAV;AADK,WAAd,CAAP;AAGD;AACD;AACA,YAAMsD,kBAAkB,oBAAYzD,MAAMzB,YAAN,CAAmB0E,MAA/B,CAAxB;AACA,YAAMS,YAAY,oBAAYzD,OAAOE,OAAnB,EACfxD,MADe,CACR;AAAA,iBAAO,CAAC8G,gBAAgBjG,QAAhB,CAAyBmG,GAAzB,CAAR;AAAA,SADQ,EAEfC,MAFe,CAER,UAACC,GAAD,EAAMF,GAAN;AAAA,iBAAc,sBAAcE,GAAd,oCAAsBF,GAAtB,EAA4B1D,OAAOE,OAAP,CAAewD,GAAf,CAA5B,EAAd;AAAA,SAFQ,EAE0D,EAF1D,CAAlB;AAGA,eAAO,kCAAO3D,KAAP,EAAc;AACnBzB,wBAAc,EAAE0E,QAAQ,EAAE/B,QAAQwC,SAAV,EAAV;AADK,SAAd,CAAP;;AAIF,WAAK,qBAAL;AACE;AACA,YAAI,CAAC1D,MAAMzB,YAAN,CAAmB0E,MAAxB,EAAgC;AAC9B,iBAAO,kCAAOjD,KAAP,EAAc;AACnBzB,0BAAc,EAAE0E,QAAQ,EAAEzC,wCAASP,OAAOE,OAAP,CAAesB,EAAxB,EAA6BxB,OAAOE,OAApC,CAAF,EAAV;AADK,WAAd,CAAP;AAGD;AACD;AACA,eAAO,kCAAOH,KAAP,EAAc;AACnBzB,wBAAc;AACZ0E,sDAAWhD,OAAOE,OAAP,CAAesB,EAA1B,EAA+B,EAAEjB,MAAMP,OAAOE,OAAf,EAA/B;AADY;AADK,SAAd,CAAP;;AAMF,WAAK,kCAAL;AACE,eAAO,kCAAOH,KAAP,EAAc;AACnBzB,wBAAc;AACZ0E,sDACGhD,OAAOE,OAAP,CAAe2D,OADlB,EAC4B;AACxBC,wBAAU,EAAEvD,MAAMP,OAAOE,OAAP,CAAe4D,QAAvB;AADc,aAD5B;AADY;AADK,SAAd,CAAP;AASF,WAAK,oCAAL;AACE,eAAO,kCAAO/D,KAAP,EAAc;AACnBzB,wBAAc;AACZ0E,sDACGhD,OAAOE,OAAP,CAAe2D,OADlB,EAC4B;AACxBC,0DACG9D,OAAOE,OAAP,CAAe6D,SADlB,EAC8B;AAC1BR,0BAAU,EAAEhD,MAAMP,OAAOE,OAAP,CAAeqD,QAAvB;AADgB,eAD9B;AADwB,aAD5B;AADY;AADK,SAAd,CAAP;AAaF,WAAK,kBAAL;AACE,eAAO,kCAAOxD,KAAP,EAAc;AACnBZ,eAAK;AACHC,4DACGY,OAAOE,OAAP,CAAe8D,IADlB,EACyB,oBAAY;AACjCC,yBAAW,sBAAc,EAAd,EAAkBA,QAAlB,CAAX;AACA,kBAAMC,YAAYlE,OAAOE,OAAP,CAAegE,SAAf,IAA4B,EAA9C;AACAA,wBAAUhC,OAAV,CAAkB,oBAAY;AAC5B,oBAAI,CAAC+B,SAASE,SAASC,OAAlB,CAAL,EAAiC;AAC/BH,2BAASE,SAASC,OAAlB,IAA6B,EAA7B;AACD;AACDH,yBAASE,SAASC,OAAlB,EAA2BD,SAASE,SAApC,IAAiD,sBAC/C;AACEC,qCAAmB,IAAIC,IAAJ;AADrB,iBAD+C,EAI/CJ,QAJ+C,CAAjD;AAMD,eAVD;AAWA,qBAAOF,QAAP;AACD,aAhBH;AADG;AADc,SAAd,CAAP;AAsBF,WAAK,mBAAL;AACE,eAAO,kCAAOlE,KAAP,EAAc;AACnBZ,eAAK;AACHE,6DACGW,OAAOE,OAAP,CAAe8D,IADlB,EACyB,oBAAY;AACjCC,yBAAW,sBAAc,EAAd,EAAkBA,QAAlB,CAAX;AADiC,qCAEGjE,OAAOE,OAFV;AAAA,kBAE1BkE,OAF0B,oBAE1BA,OAF0B;AAAA,kBAEjBI,YAFiB,oBAEjBA,YAFiB;AAAA,kBAEHC,EAFG,oBAEHA,EAFG;;AAGjC,kBAAI,CAACD,YAAL,EAAmB;AACjB,uBAAOP,QAAP;AACD;AACD,kBAAI,CAACA,SAASQ,EAAT,CAAL,EAAmB;AACjBR,yBAASQ,EAAT,IAAe,EAAf;AACD;AACD,kBAAI,CAACR,SAASQ,EAAT,EAAaL,OAAb,CAAL,EAA4B;AAC1BH,yBAASQ,EAAT,EAAaL,OAAb,IAAwB,EAAxB;AACD;AACDH,uBAASQ,EAAT,EAAaL,OAAb,EAAsBI,aAAaE,QAAnC,IAA+C,sBAC7C;AACEJ,mCAAmB,IAAIC,IAAJ;AADrB,eAD6C,EAI7CC,YAJ6C,CAA/C;AAMA,qBAAOP,QAAP;AACD,aApBH;AADG;AADc,SAAd,CAAP;;AA2BF,WAAK,wBAAL;AACE,eAAO,kCAAOlE,KAAP,EAAc;AACnBpB,mBAAS;AACPI,yBAAa;AACXtC,yBAAW,EAAE8D,MAAMP,OAAOE,OAAf,EADA;AAEXQ,uBAAS,EAAEH,MAAM,KAAR;AAFE;AADN;AADU,SAAd,CAAP;;AASF;AACA,WAAK,2BAAL;AACE,eAAO,kCAAOR,KAAP,EAAc;AACnBpB,mBAAS;AACPO,oBAAQ;AACNzC,yBAAW,EAAE8D,MAAMP,OAAOE,OAAP,CAAezD,SAAvB,EADL;AAENiE,uBAAS,EAAEH,MAAM,KAAR;AAFH;AADD;AADU,SAAd,CAAP;AAQF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACE,eAAOR,KAAP;AAvkBJ;AAykBD,GA3kBD;AA4kBD;;kBAEcnD,gB","file":"create-otp-reducer.js","sourcesContent":["import clone from 'clone'\nimport update from 'immutability-helper'\nimport isEqual from 'lodash.isequal'\n\nimport {\n  ensureSingleAccessMode,\n  getDefaultQuery,\n  getJSONFromStorage,\n  getUrlParams\n} from '../util/query'\nimport { isTransit, getTransitModes } from '../util/itinerary'\nimport { filterProfileOptions } from '../util/profile'\nimport { MobileScreens } from '../actions/ui'\n\nconst defaultConfig = {\n  autoPlan: false,\n  debouncePlanTimeMs: 0,\n  realtimeEffectsDisplayThreshold: 120,\n  operators: []\n}\n\n// Load user override settings from local storage.\n// TODO: Make this work with settings fetched from user profile API service.\nconst options = getJSONFromStorage('otp.defaultQuery')\nconst defaultQuery = Object.assign(getDefaultQuery(), options)\nconst home = getJSONFromStorage('otp.home', true)\nconst work = getJSONFromStorage('otp.work', true)\nconst trackRecent = getJSONFromStorage('otp.trackRecent', true) || false\nconst recentPlaces = getJSONFromStorage('otp.recent', true) || []\nconst recentSearches = getJSONFromStorage('otp.recentSearches', true) || []\nconst locations = [home, work, ...recentPlaces].filter(p => p)\n// TODO: parse and merge URL query params w/ default query\n\n// TODO: fire planTrip action if default query is complete/error-free\n\nfunction createOtpReducer (config, initialQuery) {\n  // populate query by merging any provided query params w/ the default params\n  const currentQuery = Object.assign(defaultQuery, initialQuery)\n  if (config.locations) {\n    locations.push(...config.locations.map(l => ({ ...l, type: 'suggested' })))\n  }\n  let queryModes = currentQuery.mode.split(',')\n\n  // If 'TRANSIT' is included in the mode list, replace it with individual modes\n  if (queryModes.includes('TRANSIT')) {\n    // Isolate the non-transit modes in queryModes\n    queryModes = queryModes.filter(m => !isTransit(m))\n    // Add all possible transit modes\n    queryModes = queryModes.concat(getTransitModes(config))\n    // Stringify and set as OTP 'mode' query param\n    currentQuery.mode = queryModes.join(',')\n  }\n\n  // If we are in 'ITINERARY' mode, ensure that one and only one access mode is selected\n  if (currentQuery.routingType === 'ITINERARY') {\n    queryModes = ensureSingleAccessMode(queryModes)\n  }\n\n  const initialState = {\n    config: Object.assign(defaultConfig, config),\n    currentQuery,\n    location: {\n      currentPosition: {\n        error: null,\n        coords: null,\n        fetching: false\n      },\n      sessionSearches: [],\n      nearbyStops: []\n    },\n    user: {\n      trackRecent,\n      locations,\n      recentSearches\n    },\n    searches: {},\n    transitIndex: {\n      stops: {},\n      trips: {}\n    },\n    useRealtime: true,\n    activeSearchId: 0,\n    overlay: {\n      bikeRental: {\n        stations: []\n      },\n      carRental: {\n        stations: []\n      },\n      parkAndRide: {\n        // null default value indicates no request for P&R list has been made\n        locations: null\n      },\n      transit: {\n        stops: []\n      },\n      transitive: null,\n      zipcar: {\n        locations: []\n      }\n    },\n    tnc: {\n      etaEstimates: {},\n      rideEstimates: {}\n    },\n    ui: {\n      mobileScreen: MobileScreens.WELCOME_SCREEN,\n      printView: window.location.href.indexOf('/print/') !== -1,\n      diagramLeg: null\n    }\n  }\n\n  return (state = initialState, action) => {\n    const searchId = action.payload && action.payload.searchId\n    switch (action.type) {\n      case 'ROUTING_REQUEST':\n        // Compute the initial activeItinerary. If this is the first search of\n        // session (i.e. searches lookup is empty/null) AND an activeItinerary ID\n        // is specified in URL parameters, use that ID. Otherwise, use null/0\n        let activeItinerary = state.currentQuery.routingType === 'ITINERARY' ? 0 : null\n        // We cannot use window.history.state here to check for the active\n        // itinerary param because it is unreliable in some states (e.g.,\n        // when the print layout component first loads).\n        const urlParams = getUrlParams()\n        if (\n          (!state.searches || Object.keys(state.searches).length === 0) &&\n          urlParams.ui_activeItinerary\n        ) {\n          activeItinerary = +urlParams.ui_activeItinerary\n        }\n\n        return update(state, {\n          searches: {\n            [searchId]: {\n              $set: {\n                activeItinerary,\n                activeLeg: null,\n                activeStep: null,\n                pending: true,\n                query: clone(state.currentQuery),\n                response: null\n              }\n            }\n          },\n          activeSearchId: { $set: searchId }\n        })\n      case 'ROUTING_ERROR':\n        return update(state, {\n          searches: {\n            [searchId]: {\n              response: {\n                $set: {\n                  error: action.payload.error\n                }\n              },\n              pending: { $set: false }\n            }\n          }\n        })\n      case 'ROUTING_RESPONSE':\n        const response = (state.currentQuery.routingType === 'PROFILE')\n          ? filterProfileOptions(action.payload.response)\n          : action.payload.response\n\n        return update(state, {\n          searches: {\n            [searchId]: {\n              response: { $set: response },\n              pending: { $set: false }\n            }\n          },\n          ui: {\n            diagramLeg: { $set: false }\n          }\n        })\n      case 'NON_REALTIME_ROUTING_RESPONSE':\n        return update(state, {\n          searches: {\n            [searchId]: {\n              nonRealtimeResponse: { $set: action.payload.response }\n            }\n          }\n        })\n      case 'BIKE_RENTAL_REQUEST':\n        return update(state, {\n          overlay: {\n            bikeRental: {\n              pending: { $set: true },\n              error: { $set: null }\n            }\n          }\n        })\n      case 'BIKE_RENTAL_ERROR':\n        return update(state, {\n          overlay: {\n            bikeRental: {\n              pending: { $set: false },\n              error: { $set: action.payload }\n            }\n          }\n        })\n      case 'BIKE_RENTAL_RESPONSE':\n        return update(state, {\n          overlay: {\n            bikeRental: {\n              stations: { $set: action.payload.stations },\n              pending: { $set: false }\n            }\n          }\n        })\n      case 'CAR_RENTAL_ERROR':\n        return update(state, {\n          overlay: {\n            carRental: {\n              pending: { $set: false },\n              error: { $set: action.payload }\n            }\n          }\n        })\n      case 'CAR_RENTAL_RESPONSE':\n        return update(state, {\n          overlay: {\n            carRental: {\n              stations: { $set: action.payload.stations },\n              pending: { $set: false }\n            }\n          }\n        })\n      case 'SET_USE_REALTIME_RESPONSE':\n        return update(state, {\n          useRealtime: { $set: action.payload.useRealtime }\n        })\n      case 'SET_ACTIVE_ITINERARY':\n        if (state.activeSearchId !== null) {\n          return update(state, {\n            searches: {\n              [state.activeSearchId]: {\n                activeItinerary: { $set: action.payload.index },\n                activeLeg: { $set: null },\n                activeStep: { $set: null }\n              }\n            }\n          })\n        }\n        return state\n      case 'SET_ACTIVE_LEG':\n        if (state.activeSearchId !== null) {\n          return update(state, {\n            searches: {\n              [state.activeSearchId]: {\n                activeLeg: { $set: action.payload.index },\n                activeStep: { $set: null }\n              }\n            }\n          })\n        }\n        return state\n      case 'SET_ACTIVE_STEP':\n        if (state.activeSearchId !== null) {\n          return update(state, {\n            searches: {\n              [state.activeSearchId]: {\n                activeStep: { $set: action.payload.index }\n              }\n            }\n          })\n        }\n        return state\n      case 'SET_LOCATION':\n        return update(state, {\n          currentQuery: {\n            [action.payload.type]: { $set: action.payload.location }\n          }\n        })\n      case 'CLEAR_LOCATION':\n        return update(state, {\n          currentQuery: { [action.payload.type]: { $set: null } }\n        })\n\n      case 'SET_QUERY_PARAM':\n        console.log('merging QPs', action.payload)\n        return update(state, { currentQuery: { $merge: action.payload } })\n\n      case 'CLEAR_ACTIVE_SEARCH':\n        return update(state, { activeSearchId: { $set: null } })\n      case 'CLEAR_DEFAULT_SETTINGS':\n        window.localStorage.removeItem('otp.defaultQuery')\n        return update(state, { defaults: { $set: null } })\n      case 'STORE_DEFAULT_SETTINGS':\n        window.localStorage.setItem('otp.defaultQuery', JSON.stringify(action.payload))\n        return update(state, { defaults: { $set: action.payload } })\n      case 'FORGET_PLACE': {\n        const locations = clone(state.user.locations)\n        const locationIndex = locations.findIndex(l => l.id === action.payload)\n        if (action.payload.indexOf('recent') !== -1) {\n          // Remove recent from list of recent places\n          const recentPlaces = locations.filter(l => l.type === 'recent')\n          const removeIndex = recentPlaces.findIndex(l => l.id === action.payload)\n          recentPlaces.splice(removeIndex, 1)\n          window.localStorage.setItem(`otp.recent`, JSON.stringify(recentPlaces))\n        } else {\n          window.localStorage.removeItem(`otp.${action.payload}`)\n        }\n        return locationIndex !== -1\n          ? update(state, { user: { locations: { $splice: [[locationIndex, 1]] } } })\n          : state\n      }\n      case 'TOGGLE_TRACKING': {\n        window.localStorage.setItem('otp.trackRecent', JSON.stringify(action.payload))\n        let locations = clone(state.user.locations)\n        if (!action.payload) {\n          // If user disables tracking, remove recent searches and locations.\n          locations = locations.filter(l => l.type !== 'recent')\n          window.localStorage.removeItem(`otp.recent`)\n          window.localStorage.removeItem(`otp.recentSearches`)\n        }\n        return update(state, { user: {\n          trackRecent: { $set: action.payload },\n          locations: { $set: locations },\n          recentSearches: { $set: [] }\n        } })\n      }\n      case 'REMEMBER_PLACE': {\n        const { location, type } = action.payload\n        const locations = clone(state.user.locations)\n        const duplicateIndex = locations.findIndex(l => l.lat === location.lat && l.lon === location.lon)\n        let locationsUpdate\n        if (location.type === 'recent') {\n          let firstIndex = -1\n          let lastIndex = -1\n          locations.forEach((l, i) => {\n            if (l.type === 'recent') {\n              if (firstIndex === -1) firstIndex = i\n              else lastIndex = i\n            }\n          })\n          const recentPlaces = locations.filter(l => l.type === 'recent')\n          if (duplicateIndex !== -1) {\n            // If duplicate index found for a recent place, do not store recent\n            // place (no state change)\n            return state\n          }\n          // Only keep up to 5 recent locations\n          // FIXME: Check for duplicates\n          if (recentPlaces.length >= 5) {\n            recentPlaces.splice(lastIndex, 1, location)\n            locationsUpdate = { $splice: [[lastIndex, 1, location]] }\n          } else {\n            recentPlaces.push(location)\n            locationsUpdate = { $push: [location] }\n          }\n          window.localStorage.setItem(`otp.recent`, JSON.stringify(recentPlaces))\n        } else {\n          if (duplicateIndex !== -1) {\n            // If a duplicate place was found for a home/work location, that's\n            // not a problem\n          }\n          // Determine if location type already exists in list\n          const index = locations.findIndex(l => l.type === type)\n          if (index !== -1) {\n            locationsUpdate = { $splice: [[index, 1, location]] }\n          } else {\n            locationsUpdate = { $push: [location] }\n          }\n          window.localStorage.setItem(`otp.${type}`, JSON.stringify(location))\n        }\n        return update(state, { user: { locations: locationsUpdate } })\n      }\n      case 'REMEMBER_SEARCH':\n        const searches = clone(state.user.recentSearches)\n        const duplicateIndex = searches.findIndex(s => isEqual(s.query, action.payload.query))\n        // Do not store a duplicate search\n        if (duplicateIndex !== -1) {\n          return state\n        }\n        searches.push(action.payload)\n        window.localStorage.setItem(`otp.recentSearches`, JSON.stringify(searches))\n        return update(state, { user: { searches: { $set: searches } } })\n      case 'FORGET_SEARCH': {\n        const recentSearches = clone(state.user.recentSearches)\n        const index = recentSearches.findIndex(l => l.id === action.payload)\n        // Remove item from list of recent searches\n        recentSearches.splice(index, 1)\n        window.localStorage.setItem(`otp.recentSearches`, JSON.stringify(recentSearches))\n        return index !== -1\n          ? update(state, { user: { recentSearches: { $splice: [[index, 1]] } } })\n          : state\n      }\n      case 'SET_AUTOPLAN':\n        return update(state, {\n          config: { autoPlan: { $set: action.payload.autoPlan } }\n        })\n      case 'SET_MAP_CENTER':\n        return update(state, {\n          config: {\n            map: {\n              initLat: { $set: action.payload.lat },\n              initLon: { $set: action.payload.lon }\n            }\n          }\n        })\n      case 'SET_MAP_ZOOM':\n        return update(state, {\n          config: {\n            map: {\n              initZoom: { $set: action.payload.zoom }\n            }\n          }\n        })\n      case 'SHOW_LEG_DIAGRAM':\n        return update(state, {\n          ui: {\n            diagramLeg: { $set: action.payload }\n          }\n        })\n      case 'SET_ELEVATION_POINT':\n        return update(state, {\n          ui: {\n            elevationPoint: { $set: action.payload }\n          }\n        })\n      case 'SET_MAP_POPUP_LOCATION':\n        return update(state, {\n          ui: {\n            mapPopupLocation: { $set: action.payload.location }\n          }\n        })\n      case 'POSITION_FETCHING':\n        return update(state, {\n          location: {\n            currentPosition: { $merge: { fetching: action.payload.type } }\n          }\n        })\n      case 'POSITION_ERROR':\n        return update(state, {\n          location: { currentPosition: { $set: action.payload } }\n        })\n      case 'POSITION_RESPONSE':\n        return update(state, {\n          location: { currentPosition: { $set: action.payload.position } }\n        })\n      case 'ADD_LOCATION_SEARCH':\n        return update(state, {\n          location: { sessionSearches: { $unshift: [action.payload.location] } }\n        })\n\n      case 'NEARBY_STOPS_RESPONSE':\n        const stopLookup = {}\n        action.payload.stops.forEach(s => {\n          stopLookup[s.id] = s\n        })\n        return update(state, {\n          location: {\n            nearbyStops: { $set: action.payload.stops.map(s => s.id) }\n          },\n          transitIndex: { stops: { $merge: stopLookup } }\n        })\n      case 'STOPS_WITHIN_BBOX_RESPONSE':\n        return update(state, {\n          overlay: {\n            transit: {\n              stops: { $set: action.payload.stops },\n              pending: { $set: false }\n            }\n          }\n        })\n      case 'CLEAR_STOPS_OVERLAY':\n        return update(state, {\n          overlay: {\n            transit: {\n              stops: { $set: [] },\n              pending: { $set: false }\n            }\n          }\n        })\n      case 'ROUTES_AT_STOP_RESPONSE':\n        return update(state, {\n          transitIndex: {\n            stops: {\n              [action.payload.stopId]: {\n                routes: { $set: action.payload.routes }\n              }\n            }\n          }\n        })\n      case 'SET_MOBILE_SCREEN':\n        return update(state, { ui: { mobileScreen: { $set: action.payload } } })\n      case 'SET_MAIN_PANEL_CONTENT':\n        return update(state, {\n          ui: { mainPanelContent: { $set: action.payload } }\n        })\n      case 'SET_VIEWED_STOP':\n        return update(state, { ui: { viewedStop: { $set: action.payload } } })\n      case 'CLEAR_VIEWED_STOP':\n        return update(state, { ui: { viewedStop: { $set: null } } })\n\n      case 'SET_VIEWED_TRIP':\n        return update(state, { ui: { viewedTrip: { $set: action.payload } } })\n      case 'CLEAR_VIEWED_TRIP':\n        return update(state, { ui: { viewedTrip: { $set: null } } })\n\n      case 'SET_VIEWED_ROUTE':\n        return update(state, { ui: { viewedRoute: { $set: action.payload } } })\n\n      case 'FIND_STOP_RESPONSE':\n        return update(state, {\n          transitIndex: {\n            stops: { [action.payload.id]: { $set: action.payload } }\n          }\n        })\n      case 'FIND_TRIP_RESPONSE':\n        return update(state, {\n          transitIndex: {\n            trips: { [action.payload.id]: { $set: action.payload } }\n          }\n        })\n      case 'FIND_STOPS_FOR_TRIP_RESPONSE':\n        return update(state, {\n          transitIndex: {\n            trips: {\n              [action.payload.tripId]: { stops: { $set: action.payload.stops } }\n            }\n          }\n        })\n      case 'FIND_STOP_TIMES_FOR_TRIP_RESPONSE':\n        return update(state, {\n          transitIndex: {\n            trips: {\n              [action.payload.tripId]: {\n                stopTimes: { $set: action.payload.stopTimes }\n              }\n            }\n          }\n        })\n      case 'FIND_GEOMETRY_FOR_TRIP_RESPONSE':\n        return update(state, {\n          transitIndex: {\n            trips: {\n              [action.payload.tripId]: {\n                geometry: { $set: action.payload.geometry }\n              }\n            }\n          }\n        })\n      case 'FIND_STOP_TIMES_FOR_STOP_RESPONSE':\n        return update(state, {\n          transitIndex: {\n            stops: {\n              [action.payload.stopId]: {\n                stopTimes: { $set: action.payload.stopTimes }\n              }\n            }\n          }\n        })\n\n      case 'FIND_ROUTES_RESPONSE':\n        // If routes is undefined, initialize it w/ the full payload\n        if (!state.transitIndex.routes) {\n          return update(state, {\n            transitIndex: { routes: { $set: action.payload } }\n          })\n        }\n        // Otherwise, merge in only the routes not already defined\n        const currentRouteIds = Object.keys(state.transitIndex.routes)\n        const newRoutes = Object.keys(action.payload)\n          .filter(key => !currentRouteIds.includes(key))\n          .reduce((res, key) => Object.assign(res, { [key]: action.payload[key] }), {})\n        return update(state, {\n          transitIndex: { routes: { $merge: newRoutes } }\n        })\n\n      case 'FIND_ROUTE_RESPONSE':\n        // If routes is undefined, initialize it w/ this route only\n        if (!state.transitIndex.routes) {\n          return update(state, {\n            transitIndex: { routes: { $set: { [action.payload.id]: action.payload } } }\n          })\n        }\n        // Otherwise, overwrite only this route\n        return update(state, {\n          transitIndex: {\n            routes: { [action.payload.id]: { $set: action.payload } }\n          }\n        })\n\n      case 'FIND_PATTERNS_FOR_ROUTE_RESPONSE':\n        return update(state, {\n          transitIndex: {\n            routes: {\n              [action.payload.routeId]: {\n                patterns: { $set: action.payload.patterns }\n              }\n            }\n          }\n        })\n      case 'FIND_GEOMETRY_FOR_PATTERN_RESPONSE':\n        return update(state, {\n          transitIndex: {\n            routes: {\n              [action.payload.routeId]: {\n                patterns: {\n                  [action.payload.patternId]: {\n                    geometry: { $set: action.payload.geometry }\n                  }\n                }\n              }\n            }\n          }\n        })\n      case 'TNC_ETA_RESPONSE':\n        return update(state, {\n          tnc: {\n            etaEstimates: {\n              [action.payload.from]: fromData => {\n                fromData = Object.assign({}, fromData)\n                const estimates = action.payload.estimates || []\n                estimates.forEach(estimate => {\n                  if (!fromData[estimate.company]) {\n                    fromData[estimate.company] = {}\n                  }\n                  fromData[estimate.company][estimate.productId] = Object.assign(\n                    {\n                      estimateTimestamp: new Date()\n                    },\n                    estimate\n                  )\n                })\n                return fromData\n              }\n            }\n          }\n        })\n      case 'TNC_RIDE_RESPONSE':\n        return update(state, {\n          tnc: {\n            rideEstimates: {\n              [action.payload.from]: fromData => {\n                fromData = Object.assign({}, fromData)\n                const {company, rideEstimate, to} = action.payload\n                if (!rideEstimate) {\n                  return fromData\n                }\n                if (!fromData[to]) {\n                  fromData[to] = {}\n                }\n                if (!fromData[to][company]) {\n                  fromData[to][company] = {}\n                }\n                fromData[to][company][rideEstimate.rideType] = Object.assign(\n                  {\n                    estimateTimestamp: new Date()\n                  },\n                  rideEstimate\n                )\n                return fromData\n              }\n            }\n          }\n        })\n\n      case 'PARK_AND_RIDE_RESPONSE':\n        return update(state, {\n          overlay: {\n            parkAndRide: {\n              locations: { $set: action.payload },\n              pending: { $set: false }\n            }\n          }\n        })\n\n      // TODO: can this be broken out into a separate module?\n      case 'ZIPCAR_LOCATIONS_RESPONSE':\n        return update(state, {\n          overlay: {\n            zipcar: {\n              locations: { $set: action.payload.locations },\n              pending: { $set: false }\n            }\n          }\n        })\n      // case 'INITIALIZE_TRANSITIVE':\n      //   const transitive = new Transitive({\n      //     data: action.payload.transitiveData,\n      //     initialBounds: action.payload.bounds,\n      //     zoomEnabled: false,\n      //     autoResize: false,\n      //     styles: require('./transitive-styles'),\n      //     zoomFactors,\n      //     display: 'canvas',\n      //     canvas\n      //   })\n      //   return update(state, {\n      //     overlay: {\n      //       transitive: { $set: }\n      //     }\n      //   })\n      default:\n        return state\n    }\n  }\n}\n\nexport default createOtpReducer\n"]}